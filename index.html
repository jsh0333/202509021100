<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>라방 게시판 분석 - 고정형(Highug/Naver)</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--text:#111;--muted:#6b7280;--border:#e5e7eb;--accent:#111;}
  *{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,Arial,sans-serif}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:grid;gap:16px}
  .row.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:900px){.row.cols-2{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .title{font-size:20px;font-weight:700}
  .muted{color:var(--muted)}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:hover{background:#fafafa}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.primary:hover{opacity:.9}
  .btn.sm{padding:6px 10px;font-size:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  textarea{width:100%;min-height:230px;border:1px solid var(--border);border-radius:12px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:10px;overflow:hidden}
  thead{background:#f9fafb}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:13px;vertical-align:top}
  tr:nth-child(even) td{background:#fafafa}
  .grid{display:grid;gap:16px}
  .right{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .hidden{display:none}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:4px 10px;font-size:12px}
  .pill{display:inline-block;padding:4px 8px;background:#eef2ff;border-radius:999px;font-size:12px}
  .note{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="container">
    <div class="right" style="margin-bottom:10px">
      <div>
        <div class="title">라방 게시판 분석</div>
        <div class="muted">붙여넣기 → <b>미리보기</b> → 표/CSV 즉시 활용 (Highug/네이버 블로그 임베드용)</div>
      </div>
      <div class="controls">
        <button class="btn" id="toggleDict">사전 편집</button>
        <button class="btn" id="resetBtn">초기화</button>
      </div>
    </div>

    <!-- 사전 편집 -->
    <div class="row cols-2 card hidden" id="dictBox">
      <div>
        <div class="right" style="margin-bottom:8px">
          <b>지역 키워드 사전(줄바꿈 구분)</b>
          <span class="note">필요시 추가/수정</span>
        </div>
        <textarea id="regions"></textarea>
      </div>
      <div>
        <div class="right" style="margin-bottom:8px">
          <b>카테고리 키워드 사전(줄바꿈 구분)</b>
          <span class="note">필요시 추가/수정</span>
        </div>
        <textarea id="categories"></textarea>
      </div>
    </div>

    <!-- 원본 입력 -->
    <div class="card">
      <div class="right" style="margin-bottom:8px">
        <b>원본 게시글 목록 붙여넣기</b>
        <div class="controls">
          <button class="btn primary" id="previewBtn">미리보기</button>
          <button class="btn" id="closePreviewBtn">미리보기 닫기</button>
        </div>
      </div>
      <textarea id="raw" placeholder="여기에 게시글 목록 전체를 붙여넣으세요. (제목/작성자/작성일/조회수/댓글 등)"></textarea>
      <div style="margin-top:8px" class="note">* 본 도구는 키워드 기반의 경량 분석입니다. 제목/작성자/조회수 등 <b>행 단위</b> 테이블 추출이 필요하면 알려주세요. 정규식 파서 버전으로 확장해 드립니다.</div>
    </div>

    <!-- 결과 -->
    <div id="result" class="grid"></div>

    <div style="margin-top:12px" class="note">
      * CSV는 엑셀에서 바로 열 수 있습니다. 네이버 블로그에선 <b>iframe</b> 임베드 권장.
    </div>
  </div>

<script>
/* ---------- 기본 사전 ---------- */
const DEFAULT_REGIONS = [
  "서울","남양주","부천","부산","인천","김포","양주","수원","하남","파주","일산","안산","안성",
  "의정부","광명","평택","화성","대구","경남","경북","경기","경기광주","상암동","마장동","남대문",
  "동대문","검단","연수구","청라","김해","양산","시흥","포천","의정부역","천안","대전","익산",
  "전남","전북","광주","울산","하남미사","사릉역"
];
const DEFAULT_CATEGORIES = [
  "아동복","여성의류","여성복","남성의류","남녀공용","잡화","악세사리","장난감","완구","문구","팬시",
  "신발","가방","향수","화장품","건강식품","건기식","식품","과자","침구","골프웨어","주얼리","가전",
  "속옷","잠옷","맘룩","빅사이즈","한복","스포츠브랜드","니트","코트","패딩","모자","양말","레깅스",
  "주방용품","원액","커피","레몬즙","간식","애견","반팔","레더팬츠","냉감","크록스","아동신발","브랜드"
];
const INTENT_KEYS = {
  "모집/공급": ["모집","모십니다","모셔요","구합니다","찾습니다","연락주세요"],
  "찾아요/문의": ["찾아요","문의","가능한 곳","있을까요","원합니다","원해요","찾고있","찾고 있"],
  "판매/팝니다": ["[팝니다]","판매합니다","정리","처분","땡처리"]
};

/* ---------- DOM ---------- */
const $raw = document.getElementById('raw');
const $regions = document.getElementById('regions');
const $categories = document.getElementById('categories');
const $result = document.getElementById('result');
const $toggleDict = document.getElementById('toggleDict');
const $dictBox = document.getElementById('dictBox');
const $previewBtn = document.getElementById('previewBtn');
const $closePreviewBtn = document.getElementById('closePreviewBtn');
const $resetBtn = document.getElementById('resetBtn');

/* 초기값 주입 */
$regions.value = DEFAULT_REGIONS.join("\n");
$categories.value = DEFAULT_CATEGORIES.join("\n");

/* ---------- 유틸 ---------- */
const esc = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
function countByKeywords(text, list){
  const rows = [];
  list.forEach(k=>{
    if(!k) return;
    const m = text.match(new RegExp(esc(k), 'g'));
    rows.push({키워드:k, 언급수: m ? m.length : 0});
  });
  return rows.filter(r=>r.언급수>0).sort((a,b)=>b.언급수 - a.언급수);
}
function intentDistribution(lines){
  const cnt = {"모집/공급":0,"찾아요/문의":0,"판매/팝니다":0,"기타":0};
  lines.forEach(s=>{
    if(!s.includes("라방")) return;
    let tagged = false;
    for(const label in INTENT_KEYS){
      if(INTENT_KEYS[label].some(k=> s.includes(k))){ cnt[label]++; tagged = true; break; }
    }
    if(!tagged) cnt["기타"]++;
  });
  return Object.entries(cnt).map(([의도,게시글수])=>({의도,게시글수})).sort((a,b)=>b.게시글수-a.게시글수);
}
function monthTimeline(text){
  const re = /(20\d{2})\.(\d{2})\.(\d{2})\./g;
  const map = new Map(); let m;
  while((m = re.exec(text))){
    const key = `${m[1]}-${m[2]}`;
    map.set(key, (map.get(key)||0)+1);
  }
  return Array.from(map.entries()).map(([월,게시글수])=>({월,게시글수})).sort((a,b)=> a.월.localeCompare(b.월));
}
function toCSV(rows){
  if(!rows || !rows.length) return "";
  const headers = Object.keys(rows[0]);
  const q=(v)=>'"'+String(v).replaceAll('"','""')+'"';
  const body = rows.map(r=> headers.map(h=> q(r[h] ?? "")).join(",")).join("\n");
  return headers.join(",")+"\n"+body;
}
function downloadCSV(filename, rows){
  const csv = toCSV(rows);
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}
function el(html){
  const div = document.createElement('div'); div.innerHTML = html.trim(); return div.firstChild;
}
function tableHTML(rows){
  if(!rows || !rows.length) return '<div class="muted">데이터가 없습니다.</div>';
  const headers = Object.keys(rows[0]);
  const th = headers.map(h=>`<th>${h}</th>`).join("");
  const tr = rows.map((r,i)=>`<tr>${headers.map(h=>`<td>${String(r[h])}</td>`).join("")}</tr>`).join("");
  return `<div class="card">
    <div class="right" style="margin-bottom:8px">
      <span class="badge"><span>행</span><b>${rows.length}</b></span>
      <button class="btn sm __dl">CSV 내보내기</button>
    </div>
    <div style="overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table>
        <thead><tr>${th}</tr></thead>
        <tbody>${tr}</tbody>
      </table>
    </div>
  </div>`;
}

/* ---------- 렌더 ---------- */
function render(){
  $result.innerHTML = "";
  const text = $raw.value || "";
  const lines = text.split(/\n|\s{2,}/).map(s=>s.trim()).filter(Boolean);
  if(!text.trim()){
    $result.appendChild(el('<div class="card muted">표시할 데이터가 없습니다. 상단 상자에 게시글 목록을 붙여넣고 <b>미리보기</b>를 눌러주세요.</div>'));
    return;
  }

  const regionList = $regions.value.split("\n").map(s=>s.trim()).filter(Boolean);
  const categoryList = $categories.value.split("\n").map(s=>s.trim()).filter(Boolean);

  const regionRows = countByKeywords(text, regionList);
  const categoryRows = countByKeywords(text, categoryList);
  const intentRows = intentDistribution(lines);
  const timelineRows = monthTimeline(text);

  const summaryRows = (()=>{
    const 최다지역 = regionRows[0]?.키워드 || "-";
    const 최다카테고리 = categoryRows[0]?.키워드 || "-";
    const 의도Top = intentRows.slice(0,3).map(r=>`${r.의도} ${r.게시글수}`).join(", ") || "-";
    const 총게시라인 = intentRows.reduce((a,b)=>a+b.게시글수, 0);
    return [
      {지표:"총 게시글 라인(추정)", 값: 총게시라인},
      {지표:"지역 키워드 총 언급수", 값: regionRows.reduce((s,r)=>s+r.언급수,0)},
      {지표:"카테고리 키워드 총 언급수", 값: categoryRows.reduce((s,r)=>s+r.언급수,0)},
      {지표:"최다 지역", 값: 최다지역},
      {지표:"최다 카테고리", 값: 최다카테고리},
      {지표:"의도 분포(상위)", 값: 의도Top},
      {지표:"감지된 월 수", 값: timelineRows.length}
    ];
  })();

  // 섹션 타이틀
  $result.appendChild(el(`<div class="card">
    <div class="right">
      <div><b>요약 지표</b></div>
      <div class="controls">
        <button class="btn sm __dl-sum">CSV 내보내기</button>
      </div>
    </div>
    <div style="overflow:auto;border:1px solid var(--border);border-radius:12px">
      ${tableHTML(summaryRows).replace('<div class="card">','<div>').replace('</div></div>','</div>')}
    </div>
  </div>`));

  // 그리드 2x2
  const grid = el('<div class="grid"></div>');
  grid.appendChild(el(`<div>
    <div class="right" style="margin-bottom:8px"><b>지역 상위(Top 30)</b></div>
    ${tableHTML(regionRows.slice(0,30))}
  </div>`));
  grid.appendChild(el(`<div>
    <div class="right" style="margin-bottom:8px"><b>카테고리 상위(Top 30)</b></div>
    ${tableHTML(categoryRows.slice(0,30))}
  </div>`));
  grid.appendChild(el(`<div>
    <div class="right" style="margin-bottom:8px"><b>의도 분포</b></div>
    ${tableHTML(intentRows)}
  </div>`));
  grid.appendChild(el(`<div>
    <div class="right" style="margin-bottom:8px"><b>월별 게시글 수</b></div>
    ${tableHTML(timelineRows)}
  </div>`));
  $result.appendChild(grid);

  // 다운로드 핸들러
  $result.querySelector('.__dl-sum')?.addEventListener('click', ()=> downloadCSV('summary.csv', summaryRows));
  const dls = $result.querySelectorAll('.__dl');
  const payloads = [regionRows.slice(0,30), categoryRows.slice(0,30), intentRows, timelineRows];
  dls.forEach((btn, i)=> btn.addEventListener('click', ()=> downloadCSV(['regions','categories','intent','timeline'][i]+'.csv', payloads[i])));
}

/* ---------- 이벤트 ---------- */
$toggleDict.addEventListener('click', ()=> $dictBox.classList.toggle('hidden'));
$previewBtn.addEventListener('click', render);
$closePreviewBtn.addEventListener('click', ()=> { $result.innerHTML=""; });
$resetBtn.addEventListener('click', ()=>{
  $raw.value=""; $regions.value = DEFAULT_REGIONS.join("\n"); $categories.value = DEFAULT_CATEGORIES.join("\n");
  $result.innerHTML=""; $dictBox.classList.add('hidden');
});
</script>
</body>
</html>
