import React, { useMemo, useState } from "react";

// ◆ 사용법
// 1) 아래 큰 텍스트 상자에 게시글 목록(지금 채팅에 올리신 내용)을 붙여넣기
// 2) "미리보기" 버튼 클릭 → 표 자동 생성 (요약/지역/카테고리/의도/월별)
// 3) 각 표 우측 상단의 CSV 내보내기로 저장(엑셀에서 열기 가능)
//
// ※ 지역/카테고리/의도 사전은 필요 시 우측 상단 [사전 편집]으로 직접 추가/수정하세요.

const DEFAULT_REGIONS = [
  "서울","남양주","부천","부산","인천","김포","양주","수원","하남","파주","일산","안산","안성",
  "의정부","광명","평택","화성","대구","경남","경북","경기","경기광주","상암동","마장동","남대문",
  "동대문","검단","연수구","청라","김해","양산","시흥","포천","의정부역","천안","대전","익산",
  "전남","전북","광주","울산","하남미사","사릉역"
];

const DEFAULT_CATEGORIES = [
  "아동복","여성의류","여성복","남성의류","남녀공용","잡화","악세사리","장난감","완구","문구","팬시",
  "신발","가방","향수","화장품","건강식품","건기식","식품","과자","침구","골프웨어","주얼리","가전",
  "속옷","잠옷","맘룩","빅사이즈","한복","스포츠브랜드","니트","코트","패딩","모자","양말","레깅스",
  "주방용품","원액","커피","레몬즙","간식","애견","반팔","레더팬츠","냉감","크록스","아동신발","브랜드"
];

const INTENT_KEYS = {
  "모집/공급": ["모집","모십니다","모셔요","구합니다","찾습니다","연락주세요"],
  "찾아요/문의": ["찾아요","문의","가능한 곳","있을까요","원합니다","원해요","찾고있","찾고 있"],
  "판매/팝니다": ["[팝니다]","판매합니다","정리","처분","땡처리"]
};

function countByKeywords(text, list){
  const map = new Map();
  list.forEach(k=>{
    const re = new RegExp(k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
    const m = text.match(re);
    if(m) map.set(k, m.length); else map.set(k, 0);
  });
  const rows = Array.from(map.entries()).map(([키워드, 언급수])=>({키워드, 언급수})).sort((a,b)=>b.언급수-a.언급수);
  return rows.filter(r=>r.언급수>0);
}

function intentDistribution(lines){
  const cnt = {"모집/공급":0, "찾아요/문의":0, "판매/팝니다":0, "기타":0};
  lines.forEach(s=>{
    if(!s.includes("라방")) return; // 라방 관련 문장만 의도 분류
    let tagged = false;
    for(const [label, keys] of Object.entries(INTENT_KEYS)){
      if(keys.some(k=> s.includes(k))){ cnt[label]++; tagged = true; break; }
    }
    if(!tagged) cnt["기타"]++;
  });
  return Object.entries(cnt).map(([의도, 게시글수])=>({의도, 게시글수})).sort((a,b)=>b.게시글수-a.게시글수);
}

function monthTimeline(text){
  const re = /(20\d{2})\.(\d{2})\.(\d{2})\./g; // YYYY.MM.DD.
  const map = new Map();
  let m;
  while((m=re.exec(text))){
    const key = `${m[1]}-${m[2]}`;
    map.set(key, (map.get(key)||0)+1);
  }
  return Array.from(map.entries()).map(([월, 게시글수])=>({월, 게시글수})).sort((a,b)=>a.월.localeCompare(b.월));
}

function toCSV(rows){
  if(!rows || !rows.length) return "";
  const headers = Object.keys(rows[0]);
  const esc = v => '"'+String(v).replaceAll('"','""')+'"';
  const body = rows.map(r=> headers.map(h=>esc(r[h] ?? '')).join(",")).join("\n");
  return headers.join(",")+"\n"+body;
}

function downloadCSV(filename, rows){
  const csv = toCSV(rows);
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

function Card({title, children, onDownload}){
  return (
    <div className="bg-white rounded-2xl shadow p-5 w-full">
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-lg font-semibold">{title}</h3>
        {onDownload && (
          <button onClick={onDownload} className="px-3 py-1 text-sm rounded-xl border hover:bg-gray-50">CSV 내보내기</button>
        )}
      </div>
      {children}
    </div>
  )
}

function Table({rows}){
  if(!rows || !rows.length) return <div className="text-gray-500 text-sm">데이터가 없습니다.</div>;
  const headers = Object.keys(rows[0]);
  return (
    <div className="overflow-auto border rounded-xl">
      <table className="min-w-full text-sm">
        <thead className="bg-gray-50">
          <tr>{headers.map(h=> <th key={h} className="text-left px-3 py-2 font-medium">{h}</th>)}</tr>
        </thead>
        <tbody>
          {rows.map((r,i)=> (
            <tr key={i} className={i%2?"bg-white":"bg-gray-50/50"}>
              {headers.map(h=> <td key={h} className="px-3 py-1.5 whitespace-pre-wrap">{String(r[h])}</td>)}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}

export default function App(){
  const [text, setText] = useState(``);
  const [regions, setRegions] = useState(DEFAULT_REGIONS.join("\n"));
  const [categories, setCategories] = useState(DEFAULT_CATEGORIES.join("\n"));
  const [showDict, setShowDict] = useState(false);
  const [ready, setReady] = useState(false);

  const lines = useMemo(()=> text.split(/\n|\s{2,}/).map(s=>s.trim()).filter(Boolean), [text]);

  const regionRows = useMemo(()=> ready ? countByKeywords(text, regions.split(/\n/).map(s=>s.trim()).filter(Boolean)) : [], [ready, text, regions]);
  const categoryRows = useMemo(()=> ready ? countByKeywords(text, categories.split(/\n/).map(s=>s.trim()).filter(Boolean)) : [], [ready, text, categories]);
  const intentRows = useMemo(()=> ready ? intentDistribution(lines) : [], [ready, lines]);
  const timelineRows = useMemo(()=> ready ? monthTimeline(text) : [], [ready, text]);

  const summaryRows = useMemo(()=>{
    if(!ready) return [];
    const 최다지역 = regionRows[0]?.키워드 || "-";
    const 최다카테고리 = categoryRows[0]?.키워드 || "-";
    const 의도Top = intentRows.slice(0,3).map(r=>`${r.의도} ${r.게시글수}`).join(", ") || "-";
    const 총게시라인 = intentRows.reduce((a,b)=>a+b.게시글수,0);
    return [
      {지표:"총 게시글 라인(추정)", 값: 총게시라인},
      {지표:"지역 키워드 총 언급수", 값: regionRows.reduce((s,r)=>s+r.언급수,0)},
      {지표:"카테고리 키워드 총 언급수", 값: categoryRows.reduce((s,r)=>s+r.언급수,0)},
      {지표:"최다 지역", 값: 최다지역},
      {지표:"최다 카테고리", 값: 최다카테고리},
      {지표:"의도 분포(상위)", 값: 의도Top},
      {지표:"감지된 월 수", 값: timelineRows.length}
    ];
  }, [ready, regionRows, categoryRows, intentRows, timelineRows]);

  return (
    <div className="min-h-screen bg-slate-100 p-6">
      <div className="max-w-6xl mx-auto space-y-6">
        <header className="flex items-start justify-between gap-4">
          <div>
            <h1 className="text-2xl font-bold">라방 게시판 분석</h1>
            <p className="text-slate-600 text-sm">붙여넣기 → <span className="font-semibold">미리보기</span> → 표·CSV 바로 활용</p>
          </div>
          <div className="flex gap-2">
            <button onClick={()=>setShowDict(s=>!s)} className="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm">사전 편집</button>
            <button onClick={()=>{ setReady(false); setText(""); }} className="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm">초기화</button>
          </div>
        </header>

        {showDict && (
          <div className="grid md:grid-cols-2 gap-4">
            <Card title="지역 키워드 사전(줄바꿈 구분)">
              <textarea className="w-full h-48 p-3 border rounded-xl font-mono text-sm" value={regions} onChange={e=>setRegions(e.target.value)} />
            </Card>
            <Card title="카테고리 키워드 사전(줄바꿈 구분)">
              <textarea className="w-full h-48 p-3 border rounded-xl font-mono text-sm" value={categories} onChange={e=>setCategories(e.target.value)} />
            </Card>
          </div>
        )}

        <Card title="원본 게시글 목록 붙여넣기">
          <textarea
            className="w-full h-64 p-3 border rounded-xl font-mono text-xs"
            placeholder="여기에 게시글 목록 전체를 붙여넣으세요."
            value={text}
            onChange={e=> setText(e.target.value)}
          />
          <div className="mt-3 flex gap-2">
            <button onClick={()=> setReady(true)} className="px-4 py-2 rounded-xl bg-black text-white hover:opacity-90">미리보기</button>
            <button onClick={()=> { setReady(false); }} className="px-4 py-2 rounded-xl border bg-white hover:bg-gray-50">미리보기 닫기</button>
          </div>
        </Card>

        {ready && (
          <div className="grid gap-4">
            <Card title="요약 지표" onDownload={()=>downloadCSV("summary.csv", summaryRows)}>
              <Table rows={summaryRows} />
            </Card>

            <div className="grid md:grid-cols-2 gap-4">
              <Card title="지역 상위(Top 30)" onDownload={()=>downloadCSV("regions.csv", regionRows)}>
                <Table rows={regionRows.slice(0,30)} />
              </Card>
              <Card title="카테고리 상위(Top 30)" onDownload={()=>downloadCSV("categories.csv", categoryRows)}>
                <Table rows={categoryRows.slice(0,30)} />
              </Card>
            </div>

            <div className="grid md:grid-cols-2 gap-4">
              <Card title="의도 분포" onDownload={()=>downloadCSV("intent.csv", intentRows)}>
                <Table rows={intentRows} />
              </Card>
              <Card title="월별 게시글 수" onDownload={()=>downloadCSV("timeline.csv", timelineRows)}>
                <Table rows={timelineRows} />
              </Card>
            </div>
          </div>
        )}

        <footer className="text-xs text-slate-500 pt-4">
          * 키워드 기반의 간단 집계입니다. 더 정밀한 정규식 추출(제목/작성자/등급/댓글/조회수 컬럼화)이 필요하면 말씀 주세요. 행 단위 시트를 추가해 드립니다.
        </footer>
      </div>
    </div>
  );
}
